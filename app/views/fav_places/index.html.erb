<h1 class="text-white text-4xl">登録場所一覧</h1>
<h1 class="text-white text-xl">地図のピンにカーソルを合わせると、場所名が出ます📍</h1><br>
<header>
  <%= link_to "TOP",root_path, data: { turbo: false },class: "w-200 bg-green-400 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition" %>

  <%= link_to "場所を保存",new_fav_place_path, data: { turbo: false }, class: "w-200 bg-green-400 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition" %>
  <!-- Google Maps処理 -->
<div id="map" style="height: 400px; width: 100%; margin-top: 2rem;"></div>

<script>
  // 複数の場所データを渡す
  const places = <%= @fav_places.to_json.html_safe %>;

  function initMap() {
    const map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: places[0].latitude, lng: places[0].longitude }, // 最初の場所を中心に設定
      zoom: 12,
      mapTypeId: "hybrid"
    });

    const geocoder = new google.maps.Geocoder();
    
    // 各場所に対してマーカーを立てる
    places.forEach(place => {
      const latLng = new google.maps.LatLng(place.latitude, place.longitude);

      // マーカーを作成
      const marker = new google.maps.Marker({
        position: latLng,
        map: map,
        title: place.fav_name || "お気に入りの場所" // 名前がある場合、それをタイトルとして使用
      });

      // 住所を取得し、必要に応じて表示
      geocoder.geocode({ 'location': latLng }, function(results, status) {
        if (status === 'OK' && results[0]) {
            const placeName = results[0].formatted_address;
            
            // 必要に応じてページに表示するなどの処理
            const placeNameInput = document.getElementById('place-name');
            if (placeNameInput) {
              placeNameInput.value = placeName;
            }
        } else {
            console.error('場所名が取得できませんでした。');
        }
      });
    });
    
    // マーカー全体が見えるように地図の範囲を調整
    const bounds = new google.maps.LatLngBounds();
    places.forEach(place => {
      bounds.extend(new google.maps.LatLng(place.latitude, place.longitude));
    });
    map.fitBounds(bounds); // 全てのマーカーが表示されるように地図の範囲を調整
  }
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API'] %>&callback=initMap"></script>

</header>
<body style="background-color: green;">
  <div class="container mx-auto px-4">
    <h1 class="text-3xl font-bold mb-8 text-white text-center">🌳　🌳　🌳</h1>

    <% if @fav_places.empty? %>
      <p class="text-white text-center text-lg">登録場所はまだありません</p>
    <% else %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <% @fav_places.each do |fav_place| %>
          <div class="bg-white text-green-800 rounded-lg shadow-md p-6">
            <p><strong>場所ID:</strong> <%= fav_place.id %></p>
            <p>
              <strong>場所名:</strong>
              <%= link_to fav_place.fav_name, fav_place_path(fav_place), class: "text-green-600 underline hover:text-green-800" %>
            </p>
            <p><strong>保存ユーザー:</strong> <%= fav_place.user.user_name %></p>
            <p><strong>保存日時:</strong> <%= l(fav_place.created_at, format: :long) %></p>
            <p><strong>住所</strong> <%= fav_place.address %></p>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</body>
