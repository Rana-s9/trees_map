<div class="flex flex-col lg:flex-row gap-6">
  <div class="w-full lg:w-3/4">

    <% if user_signed_in? %>
      <div class="mb-6">
        <%= form_with model: @fav_place, method: :post, local: true, id: 'post-form', class: "max-w-md mx-auto p-6 bg-cream-500 rounded-2xl shadow-lg" do |f| %>

          <!-- å ´æ‰€åå…¥åŠ› -->
          <div class="mb-4">
            <%= f.label :fav_name, "å ´æ‰€ã®åå‰ (è¡¨ç¤ºã•ã‚Œã¾ã™) ", class: "block text-white text-sm font-bold mb-2" %>
            <%= f.text_field :fav_name, id: "place-name", class: "w-full px-4 py-2 bg-gray text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400" %>
          </div>

          <!-- ä½æ‰€å…¥åŠ›ï¼ˆPlaceæ¤œç´¢ç”¨ï¼‰ -->
          <div class="mb-4">
            <%= f.label :address, "ä½æ‰€ ã‚‚ã—ãã¯å ´æ‰€åï¼ˆå…¥åŠ›ï¼‰", class: "block text-white text-sm font-bold mb-2" %>
            <%= f.text_field :address, id: "address-input", class: "w-full px-4 py-2 bg-gray text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" %>
          </div>

          <!-- åœ°å›³è¡¨ç¤º -->
          <div class="mb-6">
            <div id="map" style="height: 300px; width: 100%;" class="rounded-lg shadow-md"></div>
          </div>

          <!-- æŠ•ç¨¿ãƒœã‚¿ãƒ³ -->
          <div class="text-center">
            <%= f.submit "ç™»éŒ²", class: "bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-xl transition duration-200" %>
          </div>

        <% end %>
      </div>

      <!-- Google Mapså‡¦ç† -->
      <script>
        let map;
        let marker;

        function initAutocomplete() {
          const addressInput = document.getElementById('address-input');
          const placeNameInput = document.getElementById('place-name');
          const autocomplete = new google.maps.places.Autocomplete(addressInput);

          map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 35.681236, lng: 139.767125 }, // æ±äº¬é§…åˆæœŸå€¤
            zoom: 13,
          });

          autocomplete.addListener('place_changed', function () {
            const place = autocomplete.getPlace();

            if (!place.geometry) {
              alert("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
              return;
            }

            const location = place.geometry.location;
            const lat = location.lat();
            const lng = location.lng();

            // åœ°å›³ã®ä¸­å¿ƒã‚’ç§»å‹•
            map.setCenter(location);

            // ãƒãƒ¼ã‚«ãƒ¼å†è¨­ç½®
            if (marker) marker.setMap(null);
            marker = new google.maps.Marker({ map: map, position: location });

            // ç·¯åº¦çµŒåº¦ã®è¡¨ç¤º
            document.getElementById("lat-value").textContent = lat.toFixed(6);
            document.getElementById("lng-value").textContent = lng.toFixed(6);

            // ç·¯åº¦çµŒåº¦ã‚’ hidden ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿å­˜ï¼ˆRailsã«é€ä¿¡ï¼‰
            setHiddenField("fav_place[latitude]", "lat", lat);
            setHiddenField("fav_place[longitude]", "lng", lng);

            // é¸æŠã•ã‚ŒãŸå ´æ‰€ã®åå‰ã‚’ã€Œå ´æ‰€åã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è‡ªå‹•å…¥åŠ›
            if (place.name && placeNameInput) {
              placeNameInput.value = place.name;
            }
            
            getXYFromLatLng(location);
          });

          function setHiddenField(name, id, value) {
            let input = document.getElementById(id);
            if (!input) {
              input = document.createElement("input");
              input.type = "hidden";
              input.name = name;
              input.id = id;
              addressInput.form.appendChild(input);
            }
            input.value = value;
          }

          function getXYFromLatLng(latLng) {
          const scale = Math.pow(2, map.getZoom());
          const projection = map.getProjection();

          const worldCoordinate = projection.fromLatLngToPoint(latLng);
          const pixelCoordinate = {
            x: worldCoordinate.x * scale,
            y: worldCoordinate.y * scale
          };

          // hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Œã°ä»£å…¥ã€ãªã‘ã‚Œã°ç”Ÿæˆ
          setHiddenField("fav_place[fav_x]", "fav_x", pixelCoordinate.x);
          setHiddenField("fav_place[fav_y]", "fav_y", 0); // ä¸­å¤®ã«é…ç½®
          setHiddenField("fav_place[fav_z]", "fav_z", pixelCoordinate.y);
          }
        }
      </script>

      <!-- Google Maps èª­ã¿è¾¼ã¿ -->
      <script
        async
        defer
        src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API'] %>&libraries=places&callback=initAutocomplete">
      </script>
    <% else %>
      <h1 class= "text-3xl text-white"> ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ğŸ’š</h1>
    <% end %>
  </div>
  <div class="w-full lg:w-1/4">
    <%= link_to 'å ´æ‰€ä¸€è¦§', fav_places_path, data: { turbo: false }, class: "bg-light-salmon hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition inline-block" %>
    <div class="rounded-lg shadow-lg p-4">
        <h2 class="text-lg font-bold text-white mb-4">å‚è€ƒğŸŒ³ç™»éŒ²æ¸ˆã¿ã®å ´æ‰€ä¸€è¦§ğŸŒ³</h2>
        <ul class="space-y-3">
          <% if @fav_places.present? %>
            <% @fav_places.each do |fav_place| %>
              <li class="border-b pb-2">
                <p class="text-green-600 font-semibold"><%= fav_place.fav_name %></p>
                <p class="text-white text-sm"><%= fav_place.address %></p>
              </li>
            <% end %>
          <% else %>
            <p class="text-white text-center text-lg">ç™»éŒ²å ´æ‰€ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
          <% end %>
        </ul>
      </div>
  </div>
</div>